---
title: 与 MAPI 后台处理程序交互
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 5cc1d0a8-ad23-4173-b220-b7c0169073fa
description: 上次修改时间：2011 年 7 月 23 日
ms.openlocfilehash: da94347dcb47e5fdbd4a6c1d404b795f4f7938ab
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/28/2019
ms.locfileid: "33432147"
---
# <a name="interacting-with-the-mapi-spooler"></a><span data-ttu-id="f8517-103">与 MAPI 后台处理程序交互</span><span class="sxs-lookup"><span data-stu-id="f8517-103">Interacting with the MAPI Spooler</span></span>

  
  
<span data-ttu-id="f8517-104">**适用于**：Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="f8517-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="f8517-105">调用传输提供程序时，MAPI 后台处理程序使用 [IXPLogon ： IUnknown](ixplogoniunknown.md) 接口中的方法。</span><span class="sxs-lookup"><span data-stu-id="f8517-105">The methods in the [IXPLogon : IUnknown](ixplogoniunknown.md) interface are used by the MAPI spooler when calling the transport provider.</span></span> <span data-ttu-id="f8517-106">大多数类型的传输提供程序应该可以实施其中大多数方法，以便它们快速返回。</span><span class="sxs-lookup"><span data-stu-id="f8517-106">It should be possible for most types of transport providers to implement most of these methods so that they return quickly.</span></span> <span data-ttu-id="f8517-107">这是可取的，因为如果某个方法需要很长时间才返回，则该方法应该通过调用回 MAPI 后台处理程序来中断，以释放其他任务的 CPU。</span><span class="sxs-lookup"><span data-stu-id="f8517-107">This is desirable because if a method takes a long time to return then it should be broken up with calls back to the MAPI spooler to release the CPU for other tasks.</span></span> 
  
<span data-ttu-id="f8517-108">MAPI 后台处理程序执行其工作，在前台应用程序空闲时调用传输提供程序。</span><span class="sxs-lookup"><span data-stu-id="f8517-108">The MAPI spooler does its work and makes its calls to transport providers when foreground applications are idle.</span></span> <span data-ttu-id="f8517-109">在传输提供程序首次登录时显示对话框后 (由从 MAPI 传递到传输提供程序) 的标志控制，除非客户端调用来刷新发送和接收队列，否则传输提供程序将在后台运行。</span><span class="sxs-lookup"><span data-stu-id="f8517-109">After optionally displaying dialog boxes when the transport provider is first logged on (governed by flags passed from MAPI to the transport provider), transport providers operate in the background unless called by the client to flush send and receive queues.</span></span> <span data-ttu-id="f8517-110">刷新队列是传输提供程序唯一不需要释放 CPU 的时间，并且仅在用户得到可能长时间的操作正在进行时刷新队列。</span><span class="sxs-lookup"><span data-stu-id="f8517-110">Flushing queues is the only time that a transport provider need not release the CPU, and then only if the user is informed that a potentially long action is in progress.</span></span> <span data-ttu-id="f8517-111">MAPI 后台处理程序通常请求传输提供程序刷新其队列以响应用户操作，因此传输提供程序通常不需要执行任何操作来确保通知用户。</span><span class="sxs-lookup"><span data-stu-id="f8517-111">The MAPI spooler typically requests that a transport provider flush its queues in response to a user action, so the transport provider typically does not need to do anything to ensure that the user is informed.</span></span>
  
<span data-ttu-id="f8517-112">传输提供程序可以单独决定刷新队列，并使用其状态行的 PR_STATUS_CODE ([PidTagStatusCode](pidtagstatuscode-canonical-property.md)) 属性中的 **STATUS_INBOUND_FLUSH** 和 STATUS_OUTBOUND_FLUSH 位，以通知 MAPI 后台处理程序需要关注，以便可以完成作业。</span><span class="sxs-lookup"><span data-stu-id="f8517-112">A transport provider can independently decide to flush a queue and use the STATUS_INBOUND_FLUSH and STATUS_OUTBOUND_FLUSH bits in the **PR_STATUS_CODE** ([PidTagStatusCode](pidtagstatuscode-canonical-property.md)) property of its status row to inform the MAPI spooler that it wants attention so that it can get the job done.</span></span> <span data-ttu-id="f8517-113">使用 [IMAPISupport：：ModifyStatusRow 方法更新状态](imapisupport-modifystatusrow.md) 行。</span><span class="sxs-lookup"><span data-stu-id="f8517-113">The status row is updated using the [IMAPISupport::ModifyStatusRow](imapisupport-modifystatusrow.md) method.</span></span> <span data-ttu-id="f8517-114">在这种情况下，传输提供程序可能应显示进度指示器或其他界面，以通知用户正在执行长操作。</span><span class="sxs-lookup"><span data-stu-id="f8517-114">In this case the transport provider should probably display a progress indicator or other interface to inform the user that a long action is occuring.</span></span> 
  
<span data-ttu-id="f8517-115">由于网络活动通常需要 0.2 秒以上的时间，因此传输提供程序应尽可能使用异步网络请求。</span><span class="sxs-lookup"><span data-stu-id="f8517-115">Since network activity often takes more than 0.2 seconds, transport providers should, whenever possible, use asynchronous network requests.</span></span> <span data-ttu-id="f8517-116">这使用户能够启动请求、通过回调用 MAPI 后台处理程序释放 CPU，并且当 MAPI 后台处理程序再次授予其控制权时，可以检查其网络请求是否已完成。</span><span class="sxs-lookup"><span data-stu-id="f8517-116">This enables them to initiate a request, release the CPU by calling back to the MAPI spooler, and when the MAPI spooler again gives them control, to check to see if their network request has completed.</span></span> <span data-ttu-id="f8517-117">如果尚未完成，它们再次使用 [IMAPISupport：：SpoolerYield](imapisupport-spooleryield.md) 方法调用 MAPI 后台处理程序来释放 CPU。</span><span class="sxs-lookup"><span data-stu-id="f8517-117">If it has not yet completed, they again release the CPU by calling back to the MAPI spooler with the [IMAPISupport::SpoolerYield](imapisupport-spooleryield.md) method.</span></span> 
  
<span data-ttu-id="f8517-118">在处理邮件期间， [在 IXPLogon：：SubmitMessage](ixplogon-submitmessage.md) 和 [IXPLogon：：EndMessage](ixplogon-endmessage.md) 之间以及 [IXPLogon：：StartMessage](ixplogon-startmessage.md)期间，传输提供程序通常会对 MAPI 后台处理程序向它公开的对象进行多次调用。</span><span class="sxs-lookup"><span data-stu-id="f8517-118">During message processing, between [IXPLogon::SubmitMessage](ixplogon-submitmessage.md) and [IXPLogon::EndMessage](ixplogon-endmessage.md) and during [IXPLogon::StartMessage](ixplogon-startmessage.md), the transport provider typically makes many calls on objects exposed to it by the MAPI spooler.</span></span> <span data-ttu-id="f8517-119">作为处理这些对象的一部分，MAPI 后台处理程序通过在适当时自行生成来帮助传输提供程序适当地作为后台进程运行。</span><span class="sxs-lookup"><span data-stu-id="f8517-119">As part of its handling of these objects, the MAPI spooler helps the transport provider behave appropriately as a background process by yielding on its own when appropriate.</span></span> <span data-ttu-id="f8517-120">需要时间关键处理的传输提供程序可以使用 [IMAPISupport：：SpoolerNotify](imapisupport-spoolernotify.md) 支持对象方法向 MAPI 后台处理程序声明关键节。</span><span class="sxs-lookup"><span data-stu-id="f8517-120">A transport provider requiring time-critical processing can declare a critical section to the MAPI spooler using the [IMAPISupport::SpoolerNotify](imapisupport-spoolernotify.md) support object method.</span></span> <span data-ttu-id="f8517-121">在这种情况下，CPU 仅在传输提供程序的显式 **SpoolerYield** 调用上释放，直到传输提供程序通过另一个对 **SpoolerNotify** 的调用结束关键节处理。</span><span class="sxs-lookup"><span data-stu-id="f8517-121">In this case, the CPU is released only on explicit **SpoolerYield** calls by the transport provider until the transport provider ends critical section processing with another call to **SpoolerNotify**.</span></span>
  
> [!NOTE]
> <span data-ttu-id="f8517-122">这与 Win32 关键部分不同。</span><span class="sxs-lookup"><span data-stu-id="f8517-122">This is not the same as a Win32 critical section.</span></span> <span data-ttu-id="f8517-123">只有在传输提供程序需要实时控制外部资源（如从传真行读取传入数据）时，才应完成此操作。</span><span class="sxs-lookup"><span data-stu-id="f8517-123">This should only be done when the transport provider needs real-time control of external resources such as reading incoming data from a fax line.</span></span> <span data-ttu-id="f8517-124">由于这提高了 MAPI 后台处理程序进程的优先级，并且可能导致工作站在操作期间无响应，因此，建议通知用户一个可能很长操作正在进行，并提供进度指示器（如果可能）。</span><span class="sxs-lookup"><span data-stu-id="f8517-124">Since this raises the priority of the MAPI spooler process and can cause the workstation to be unresponsive for the duration of the operation, it is a good idea to notify the user that a potentially long action is underway and provide a progress indicator if possible.</span></span> 
  

