---
title: 实现 FlushQueues 方法
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 8719f8aa-a537-4253-b67d-c4d38c40472b
description: 上次修改时间：2015 年 3 月 9 日
ms.openlocfilehash: 01296995adbca2640c8da42b4d06c1c749be3266
ms.sourcegitcommit: 0cf39e5382b8c6f236c8a63c6036849ed3527ded
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/23/2018
ms.locfileid: "22582411"
---
# <a name="implementing-the-flushqueues-method"></a><span data-ttu-id="42d2f-103">实现 FlushQueues 方法</span><span class="sxs-lookup"><span data-stu-id="42d2f-103">Implementing the FlushQueues Method</span></span>

  
  
<span data-ttu-id="42d2f-104">**适用于**： Outlook 2013 |Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="42d2f-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="42d2f-105">MAPI 后台处理程序使用[IXPLogon::FlushQueues](ixplogon-flushqueues.md)方法下载和上载任何挂起邮件与传输提供程序。</span><span class="sxs-lookup"><span data-stu-id="42d2f-105">The MAPI spooler uses the [IXPLogon::FlushQueues](ixplogon-flushqueues.md) method to download and upload any pending messages to and from a transport provider.</span></span> <span data-ttu-id="42d2f-106">通常，MAPI 后台处理程序将刷新队列的所有传输提供程序登录到会话，用户的配置文件传输顺序部分中设置启动的第一个传输提供程序。</span><span class="sxs-lookup"><span data-stu-id="42d2f-106">Typically, the MAPI spooler will flush the queues for all transport providers that are logged on to the session, starting with the first transport provider as set in the transport order section of the user's profile.</span></span> <span data-ttu-id="42d2f-107">刷新队列始终是由用户，直接请求的结果，因此发送和接收的消息时将刷新队列是同步到 MAPI 后台处理程序。</span><span class="sxs-lookup"><span data-stu-id="42d2f-107">Flushing queues is almost always the result of a direct request by the user, so the sending and receiving of messages while queues are flushing is synchronous to the MAPI spooler.</span></span> <span data-ttu-id="42d2f-108">这些呼叫是同步的因为传输提供程序应尽可能快地处理它们。</span><span class="sxs-lookup"><span data-stu-id="42d2f-108">Because these calls are synchronous, the transport provider should process them as quickly as possible.</span></span> 
  
<span data-ttu-id="42d2f-109">传输提供程序必须处理**FlushQueues**呼叫的步骤顺序如下所述启用适当的消息处理以及启用外部的资源，如调制解调器的 MAPI 后台处理程序的一部分使用由其他传输提供程序**FlushQueues**操作。</span><span class="sxs-lookup"><span data-stu-id="42d2f-109">Transport providers must handle the **FlushQueues** call as described in the following sequence of steps to enable proper message processing and to enable external resources such as modems to be used by other transport providers as part of the MAPI spooler's **FlushQueues** operation.</span></span> 
  
|<span data-ttu-id="42d2f-110">**步骤**</span><span class="sxs-lookup"><span data-stu-id="42d2f-110">**Step**</span></span>|<span data-ttu-id="42d2f-111">**组件**</span><span class="sxs-lookup"><span data-stu-id="42d2f-111">**Component**</span></span>|<span data-ttu-id="42d2f-112">**实现**</span><span class="sxs-lookup"><span data-stu-id="42d2f-112">**Implementation**</span></span>|
|:-----|:-----|:-----|
|<span data-ttu-id="42d2f-113">1。</span><span class="sxs-lookup"><span data-stu-id="42d2f-113">1.</span></span>  <br/> |<span data-ttu-id="42d2f-114">MAPI 后台处理程序</span><span class="sxs-lookup"><span data-stu-id="42d2f-114">MAPI spooler</span></span>  <br/> |<span data-ttu-id="42d2f-115">为第一个传输提供程序中的用户配置的传输顺序列出传递_ulFlags_参数中的请求的标志调用**FlushQueues**方法。</span><span class="sxs-lookup"><span data-stu-id="42d2f-115">Calls the **FlushQueues** method for the first transport provider listed in the transport order of the user's profile, passing the requested flags in the  _ulFlags_ parameter.</span></span> <span data-ttu-id="42d2f-116">与所有标志设置为整个上载和下载操作调用**FlushQueues**一次。</span><span class="sxs-lookup"><span data-stu-id="42d2f-116">**FlushQueues** is called once with all flags set for the entire upload and download operation.</span></span>  <br/> |
|<span data-ttu-id="42d2f-117">2。</span><span class="sxs-lookup"><span data-stu-id="42d2f-117">2.</span></span>  <br/> |<span data-ttu-id="42d2f-118">传输提供程序</span><span class="sxs-lookup"><span data-stu-id="42d2f-118">Transport Provider</span></span>  <br/> |<span data-ttu-id="42d2f-119">需要从**FlushQueues**呼叫返回之前执行大量操作。</span><span class="sxs-lookup"><span data-stu-id="42d2f-119">Needs to do a number of things before returning from the **FlushQueues** call.</span></span> <span data-ttu-id="42d2f-120">如果以前提交的邮件将被延迟， [IMAPISupport::SpoolerNotify](imapisupport-spoolernotify.md)方法应调用设置了 NOTIFY_SENT_DEFERRED 标志。</span><span class="sxs-lookup"><span data-stu-id="42d2f-120">If previously submitted messages are being deferred, the [IMAPISupport::SpoolerNotify](imapisupport-spoolernotify.md) method should be called with the NOTIFY_SENT_DEFERRED flag set.</span></span> <span data-ttu-id="42d2f-121">请注意，可能为 MAPI 后台处理程序取消一条消息，已传输提供程序之前延迟有机会完成处理邮件。</span><span class="sxs-lookup"><span data-stu-id="42d2f-121">Note that it is possible for the MAPI spooler to cancel a message that has been deferred before the transport provider has a chance to finish processing the message.</span></span>  <br/> <span data-ttu-id="42d2f-122">如果传输提供程序使用外部资源，如调制解调器，应该建立的连接到外部资源。</span><span class="sxs-lookup"><span data-stu-id="42d2f-122">If the transport provider uses an external resource such as a modem, the connection to the external resource should be established.</span></span>  <br/> <span data-ttu-id="42d2f-123">必须使用[IMAPISupport::ModifyStatusRow](imapisupport-modifystatusrow.md)方法设置 STATUS_OUTBOUND_FLUSH 位传输提供程序的状态行的**PR_STATUS_CODE** ([PidTagStatusCode](pidtagstatuscode-canonical-property.md)) 属性中。</span><span class="sxs-lookup"><span data-stu-id="42d2f-123">The STATUS_OUTBOUND_FLUSH bit in the **PR_STATUS_CODE** ([PidTagStatusCode](pidtagstatuscode-canonical-property.md)) property of the transport provider's status row must be set using the [IMAPISupport::ModifyStatusRow](imapisupport-modifystatusrow.md) method.</span></span>  <br/> <span data-ttu-id="42d2f-124">传输提供程序然后应**FlushQueues**呼叫返回 S_OK。</span><span class="sxs-lookup"><span data-stu-id="42d2f-124">The transport provider should then return S_OK for the **FlushQueues** call.</span></span>  <br/> |
|<span data-ttu-id="42d2f-125">3.</span><span class="sxs-lookup"><span data-stu-id="42d2f-125">3.</span></span>  <br/> |<span data-ttu-id="42d2f-126">MAPI 后台处理程序</span><span class="sxs-lookup"><span data-stu-id="42d2f-126">MAPI spooler</span></span>  <br/> |<span data-ttu-id="42d2f-127">检查 STATUS_OUTBOUND_FLUSH 位传输提供程序的状态行，并调用[IXPLogon::SubmitMessage](ixplogon-submitmessage.md)程序队列中的第一条消息。</span><span class="sxs-lookup"><span data-stu-id="42d2f-127">Checks the transport provider's status row for the STATUS_OUTBOUND_FLUSH bit and calls [IXPLogon::SubmitMessage](ixplogon-submitmessage.md) for the first message in the queue.</span></span>  <br/> |
|<span data-ttu-id="42d2f-128">4。</span><span class="sxs-lookup"><span data-stu-id="42d2f-128">4.</span></span>  <br/> |<span data-ttu-id="42d2f-129">传输提供程序</span><span class="sxs-lookup"><span data-stu-id="42d2f-129">Transport provider</span></span>  <br/> |<span data-ttu-id="42d2f-130">处理邮件，并返回从**SubmitMessage**呼叫。</span><span class="sxs-lookup"><span data-stu-id="42d2f-130">Handles the message and returns from the **SubmitMessage** call.</span></span>  <br/> |
|<span data-ttu-id="42d2f-131">5。</span><span class="sxs-lookup"><span data-stu-id="42d2f-131">5.</span></span>  <br/> |<span data-ttu-id="42d2f-132">MAPI 后台处理程序</span><span class="sxs-lookup"><span data-stu-id="42d2f-132">MAPI spooler</span></span>  <br/> |<span data-ttu-id="42d2f-133">如果传输提供程序从**SubmitMessage**返回 S_OK，MAPI 后台处理程序调用邮件[IXPLogon::EndMessage](ixplogon-endmessage.md) ，，这与正常的消息发送。</span><span class="sxs-lookup"><span data-stu-id="42d2f-133">If the transport provider returns S_OK from **SubmitMessage**, the MAPI spooler calls [IXPLogon::EndMessage](ixplogon-endmessage.md) for the message as it does with regular message sending.</span></span>  <br/> <span data-ttu-id="42d2f-134">传输提供程序从**SubmitMessage**返回 S_OK 之外的一个值，如果 MAPI 后台处理程序处理值相应地之前调用**EndMessage**，或再次调用**SubmitMessage**之前。</span><span class="sxs-lookup"><span data-stu-id="42d2f-134">If the transport provider returns a value other than S_OK from **SubmitMessage**, the MAPI spooler handles the value appropriately before calling **EndMessage**, or before calling **SubmitMessage** again.</span></span>  <br/> |
|<span data-ttu-id="42d2f-135">6。</span><span class="sxs-lookup"><span data-stu-id="42d2f-135">6.</span></span>  <br/> |<span data-ttu-id="42d2f-136">传输提供程序</span><span class="sxs-lookup"><span data-stu-id="42d2f-136">Transport provider</span></span>  <br/> |<span data-ttu-id="42d2f-137">返回的范围是从**EndMessage**与其消息处理_lpulFlags_参数中的状态。</span><span class="sxs-lookup"><span data-stu-id="42d2f-137">Returns from **EndMessage** with its message processing status in the  _lpulFlags_ parameter.</span></span>  <br/> |
|<span data-ttu-id="42d2f-138">7。</span><span class="sxs-lookup"><span data-stu-id="42d2f-138">7.</span></span>  <br/> |<span data-ttu-id="42d2f-139">MAPI 后台处理程序和传输提供程序</span><span class="sxs-lookup"><span data-stu-id="42d2f-139">MAPI spooler and transport provider</span></span>  <br/> |<span data-ttu-id="42d2f-140">**SubmitMessage**- 继续**EndMessage**循环，直到已下载队列中的所有邮件。</span><span class="sxs-lookup"><span data-stu-id="42d2f-140">The **SubmitMessage**- **EndMessage** loop continues until all messages in the queue have been downloaded.</span></span>  <br/> |
|<span data-ttu-id="42d2f-141">8。</span><span class="sxs-lookup"><span data-stu-id="42d2f-141">8.</span></span>  <br/> |<span data-ttu-id="42d2f-142">MAPI 后台处理程序</span><span class="sxs-lookup"><span data-stu-id="42d2f-142">MAPI spooler</span></span>  <br/> |<span data-ttu-id="42d2f-143">通知传输提供程序，它已完成下载邮件通过调用设置了 NOTIFY_END_OUTBOUND_FLUSH 标志的传输提供程序的[IXPLogon::TransportNotify](ixplogon-transportnotify.md)方法。</span><span class="sxs-lookup"><span data-stu-id="42d2f-143">Notifies the transport provider that it has finished downloading messages by calling the transport provider's [IXPLogon::TransportNotify](ixplogon-transportnotify.md) method with the NOTIFY_END_OUTBOUND_FLUSH flag set.</span></span>  <br/> |
|<span data-ttu-id="42d2f-144">9。</span><span class="sxs-lookup"><span data-stu-id="42d2f-144">9.</span></span>  <br/> |<span data-ttu-id="42d2f-145">传输提供程序</span><span class="sxs-lookup"><span data-stu-id="42d2f-145">Transport provider</span></span>  <br/> |<span data-ttu-id="42d2f-146">释放发送出站邮件，以便他们可以使用由其他传输提供程序刷新其队列中使用的任何外部资源。</span><span class="sxs-lookup"><span data-stu-id="42d2f-146">Frees any external resources used in sending outbound messages so they can be used by other transport providers to flush their queues.</span></span>  <br/> <span data-ttu-id="42d2f-147">必须使用**ModifyStatusRow**设置中的传输提供程序的状态行的**PR_STATUS_CODE**属性位 STATUS_INBOUND_FLUSH。</span><span class="sxs-lookup"><span data-stu-id="42d2f-147">The STATUS_INBOUND_FLUSH bit in the **PR_STATUS_CODE** property of the transport provider's status row must be set using **ModifyStatusRow**.</span></span>  <br/> |
|<span data-ttu-id="42d2f-148">10。</span><span class="sxs-lookup"><span data-stu-id="42d2f-148">10.</span></span>  <br/> |<span data-ttu-id="42d2f-149">MAPI 后台处理程序</span><span class="sxs-lookup"><span data-stu-id="42d2f-149">MAPI spooler</span></span>  <br/> |<span data-ttu-id="42d2f-150">检查 STATUS_INBOUND_FLUSH 位传输提供程序的状态行，并调用[IXPLogon::StartMessage](ixplogon-startmessage.md) ，如果将其设置。</span><span class="sxs-lookup"><span data-stu-id="42d2f-150">Checks the transport provider's status row for the STATUS_INBOUND_FLUSH bit and calls [IXPLogon::StartMessage](ixplogon-startmessage.md) if it is set.</span></span>  <br/> |
|<span data-ttu-id="42d2f-151">11。</span><span class="sxs-lookup"><span data-stu-id="42d2f-151">11.</span></span>  <br/> |<span data-ttu-id="42d2f-152">传输提供程序</span><span class="sxs-lookup"><span data-stu-id="42d2f-152">Transport provider</span></span>  <br/> |<span data-ttu-id="42d2f-153">处理邮件，并返回从**StartMessage**。</span><span class="sxs-lookup"><span data-stu-id="42d2f-153">Processes the message and returns from **StartMessage**.</span></span> <span data-ttu-id="42d2f-154">如果传输提供程序具有上载其他消息，它应调用**SpoolerNotify**设置了 NOTIFY_NEWMAIL 标志。</span><span class="sxs-lookup"><span data-stu-id="42d2f-154">If the transport provider has other messages to upload, it should call **SpoolerNotify** with the NOTIFY_NEWMAIL flag set.</span></span>  <br/> <span data-ttu-id="42d2f-155">如果传输提供程序不具有上载任何消息，它应 MAPI 后台处理程序中**StartMessage**传递，并返回对邮件调用[IMAPIProp::SaveChanges](imapiprop-savechanges.md) 。</span><span class="sxs-lookup"><span data-stu-id="42d2f-155">If the transport provider has no messages to upload, it should call [IMAPIProp::SaveChanges](imapiprop-savechanges.md) on the message the MAPI spooler passed in **StartMessage** and return.</span></span>  <br/> |
|<span data-ttu-id="42d2f-156">12。</span><span class="sxs-lookup"><span data-stu-id="42d2f-156">12.</span></span>  <br/> |<span data-ttu-id="42d2f-157">MAPI 后台处理程序</span><span class="sxs-lookup"><span data-stu-id="42d2f-157">MAPI spooler</span></span>  <br/> |<span data-ttu-id="42d2f-158">继续调用**StartMessage** ，直到**SaveChanges**调用上一条消息。</span><span class="sxs-lookup"><span data-stu-id="42d2f-158">Continues calling **StartMessage** until **SaveChanges** is called on a message.</span></span> <span data-ttu-id="42d2f-159">传输提供程序完成上载后，则 MAPI 后台处理程序调用**TransportNotify**设置了 NOTIFY_END_INBOUND_FLUSH 标志。</span><span class="sxs-lookup"><span data-stu-id="42d2f-159">After the transport provider has finished uploading, the MAPI spooler calls **TransportNotify** with the NOTIFY_END_INBOUND_FLUSH flag set.</span></span>  <br/> |
|<span data-ttu-id="42d2f-160">13。</span><span class="sxs-lookup"><span data-stu-id="42d2f-160">13.</span></span>  <br/> |<span data-ttu-id="42d2f-161">传输提供程序</span><span class="sxs-lookup"><span data-stu-id="42d2f-161">Transport provider</span></span>  <br/> |<span data-ttu-id="42d2f-162">清除由其他传输提供程序中使用**ModifyStatusRow**和所有外部的资源，以使其可供使用的版本其状态行的**PR_STATUS_CODE**属性位 STATUS_INBOUND_FLUSH。</span><span class="sxs-lookup"><span data-stu-id="42d2f-162">Clears the STATUS_INBOUND_FLUSH bit in the **PR_STATUS_CODE** property of its status row using **ModifyStatusRow** and releases all external resources so they are available for use by other transport providers.</span></span>  <br/> |
|<span data-ttu-id="42d2f-163">14。</span><span class="sxs-lookup"><span data-stu-id="42d2f-163">14.</span></span>  <br/> |<span data-ttu-id="42d2f-164">MAPI 后台处理程序</span><span class="sxs-lookup"><span data-stu-id="42d2f-164">MAPI spooler</span></span>  <br/> |<span data-ttu-id="42d2f-165">为下一个传输提供程序的用户的配置文件传输顺序列出调用**FlushQueues** 。</span><span class="sxs-lookup"><span data-stu-id="42d2f-165">Calls **FlushQueues** for the next transport provider listed in the transport order of the user's profile.</span></span>  <br/> |
   
<span data-ttu-id="42d2f-166">如果客户端应用程序[IMAPIStatus::FlushQueues](imapistatus-flushqueues.md)对象上的调用传输提供程序的状态，传输提供程序应与**ModifyStatusRow**其状态行中设置相应的位。</span><span class="sxs-lookup"><span data-stu-id="42d2f-166">If a client application calls [IMAPIStatus::FlushQueues](imapistatus-flushqueues.md) on a transport provider's status object, the transport provider should set the appropriate bit in its status row with **ModifyStatusRow**.</span></span> <span data-ttu-id="42d2f-167">MAPI 后台处理程序然后在 MAPI 后台处理程序的方便调用传输提供程序的**IXPLogon::FlushQueues**方法。</span><span class="sxs-lookup"><span data-stu-id="42d2f-167">The MAPI spooler then calls the transport provider's **IXPLogon::FlushQueues** method at the MAPI spooler's convenience.</span></span> <span data-ttu-id="42d2f-168">传输提供程序的**IXPLogon::FlushQueues**方法调用时客户端应用程序的**IMAPIStatus::FlushQueues**呼叫，由于操作发生异步客户端应用程序。</span><span class="sxs-lookup"><span data-stu-id="42d2f-168">When the transport provider's **IXPLogon::FlushQueues** method is called as a result of a client application's **IMAPIStatus::FlushQueues** call, the operation occurs asynchronously to the client application.</span></span> <span data-ttu-id="42d2f-169">否则**IXPLogon::FlushQueues**适用于同步的 MAPI 后台处理程序。</span><span class="sxs-lookup"><span data-stu-id="42d2f-169">Otherwise **IXPLogon::FlushQueues** works synchronously with the MAPI spooler.</span></span> 
  
<span data-ttu-id="42d2f-170">出于性能原因，MAPI 后台处理程序仅将调用传输提供程序的**FlushQueues**方法，如果传输提供程序的状态行中设置了 STATUS_INBOUND_FLUSH 和 STATUS_OUTBOUND_FLUSH 标志。</span><span class="sxs-lookup"><span data-stu-id="42d2f-170">For performance reasons, the MAPI spooler will only call a transport provider's **FlushQueues** method if the STATUS_INBOUND_FLUSH and STATUS_OUTBOUND_FLUSH flags are set in the transport provider's status row.</span></span> <span data-ttu-id="42d2f-171">因此，传输提供程序可以通过清除其状态行中的 STATUS_OUTBOUND_FLUSH 和 STATUS_INBOUND_FLUSH 标志停止随时**FlushQueues**操作。</span><span class="sxs-lookup"><span data-stu-id="42d2f-171">Consequently, a transport provider can stop the **FlushQueues** operation at any time by clearing the STATUS_OUTBOUND_FLUSH and STATUS_INBOUND_FLUSH flags in its status row.</span></span> <span data-ttu-id="42d2f-172">如果 MAPI 后台处理程序已关闭，并且需要结束**FlushQueues**操作，则设置的 NOTIFY_END_INBOUND_FLUSH 和 NOTIFY_END_OUTBOUND_FLUSH flags 调用**TransportNotify** 。</span><span class="sxs-lookup"><span data-stu-id="42d2f-172">If the MAPI spooler is shutting down and needs to end the **FlushQueues** operation, it calls **TransportNotify** with both the NOTIFY_END_INBOUND_FLUSH and NOTIFY_END_OUTBOUND_FLUSH flags set.</span></span> <span data-ttu-id="42d2f-173">传输提供程序应释放所有外部的资源，并返回。</span><span class="sxs-lookup"><span data-stu-id="42d2f-173">The transport provider should release all external resources and return.</span></span> 
  

