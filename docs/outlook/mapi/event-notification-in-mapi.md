---
title: MAPI 中的事件通知
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 7b3b625b-6dea-4b12-99a9-152935bdfe39
description: 上次修改时间：2011 年 7 月 23 日
ms.openlocfilehash: 30d4ad5e0fc1ecdc4c8eb06f75d39e38dd481269
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/23/2019
ms.locfileid: "32321392"
---
# <a name="event-notification-in-mapi"></a><span data-ttu-id="80767-103">MAPI 中的事件通知</span><span class="sxs-lookup"><span data-stu-id="80767-103">Event notification in MAPI</span></span>

<span data-ttu-id="80767-104">**适用于**：Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="80767-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="80767-105">事件通知是两个 MAPI 对象之间的信息通信。</span><span class="sxs-lookup"><span data-stu-id="80767-105">Event notification is the communication of information between two MAPI objects.</span></span> <span data-ttu-id="80767-106">通过其中一个对象，客户端或服务提供商注册以通知可能在其他对象中发生的变化或错误（称为事件）。</span><span class="sxs-lookup"><span data-stu-id="80767-106">Through one of the objects, a client or service provider registers for notification of a change or error, called an event, which may take place in the other object.</span></span> <span data-ttu-id="80767-107">事件发生后，第一个对象将收到更改或错误通知。</span><span class="sxs-lookup"><span data-stu-id="80767-107">After the event occurs, the first object is notified of the change or error.</span></span> <span data-ttu-id="80767-108">接收通知的对象称为通知接收器;负责通知的对象称为建议源。</span><span class="sxs-lookup"><span data-stu-id="80767-108">The object receiving the notification is called the advise sink; the object responsible for the notification is called the advise source.</span></span>
  
<span data-ttu-id="80767-109">建议接收器对象有三 (类型都是标准 MAPI 对象) ：</span><span class="sxs-lookup"><span data-stu-id="80767-109">There are three types of advise sink objects (all types are standard MAPI objects):</span></span>
  
- <span data-ttu-id="80767-110">建议接收对象。</span><span class="sxs-lookup"><span data-stu-id="80767-110">Advise sink objects.</span></span>   
- <span data-ttu-id="80767-111">窗体建议接收对象。</span><span class="sxs-lookup"><span data-stu-id="80767-111">Form advise sink objects.</span></span>  
- <span data-ttu-id="80767-112">查看通知接收对象。</span><span class="sxs-lookup"><span data-stu-id="80767-112">View advise sink objects.</span></span>
    
<span data-ttu-id="80767-113">建议接收对象是最常见的类型。</span><span class="sxs-lookup"><span data-stu-id="80767-113">Advise sink objects are the most common type.</span></span> <span data-ttu-id="80767-114">建议接收器通常由客户端应用程序实现，以接收通讯簿和消息存储通知并支持 [IMAPIAdviseSink ： IUnknown](imapiadvisesinkiunknown.md) 接口。</span><span class="sxs-lookup"><span data-stu-id="80767-114">Advise sinks are typically implemented by client applications to receive address book and message store notifications and support the [IMAPIAdviseSink : IUnknown](imapiadvisesinkiunknown.md) interface.</span></span> <span data-ttu-id="80767-115">**IMAPIAdviseSink** 包含单个方法 [IMAPIAdviseSink：：OnNotify](imapiadvisesink-onnotify.md)。</span><span class="sxs-lookup"><span data-stu-id="80767-115">**IMAPIAdviseSink** contains a single method, [IMAPIAdviseSink::OnNotify](imapiadvisesink-onnotify.md).</span></span> <span data-ttu-id="80767-116">窗体和视图建议接收器不太常见;实现它们以接收有关自定义窗体更改的通知。</span><span class="sxs-lookup"><span data-stu-id="80767-116">Form and view advise sinks are less common; they are implemented to receive notifications about changes to custom forms.</span></span> <span data-ttu-id="80767-117">表单通知接收器支持 [IMAPIFormAdviseSink ： IUnknown](imapiformadvisesinkiunknown.md) 接口和视图通知接收器支持 [IMAPIViewAdviseSink ： IUnknown](imapiviewadvisesinkiunknown.md) 接口。</span><span class="sxs-lookup"><span data-stu-id="80767-117">Form advise sinks support the [IMAPIFormAdviseSink : IUnknown](imapiformadvisesinkiunknown.md) interface and view advise sinks support the [IMAPIViewAdviseSink : IUnknown](imapiviewadvisesinkiunknown.md) interface.</span></span> <span data-ttu-id="80767-118">由于大多数客户端都实现了标准建议接收对象，因此假定有关通知的讨论与通讯簿和邮件存储通知有关，而不是与窗体通知相关。</span><span class="sxs-lookup"><span data-stu-id="80767-118">Because most clients implement standard advise sink objects, assume that discussions of notifications relate to address book and message store notifications rather than forms notifications.</span></span> <span data-ttu-id="80767-119">有关窗体通知详细信息，请参阅 [MAPI 窗体通知](mapi-forms-notifications.md) 和 [编写窗体服务器代码](writing-form-server-code.md)。</span><span class="sxs-lookup"><span data-stu-id="80767-119">For more information about forms notifications, see [MAPI Forms Notifications](mapi-forms-notifications.md) and [Writing Form Server Code](writing-form-server-code.md).</span></span>
  
<span data-ttu-id="80767-120">建议源对象由服务提供商和 MAPI 实现。</span><span class="sxs-lookup"><span data-stu-id="80767-120">Advise source objects are implemented by service providers and by MAPI.</span></span> <span data-ttu-id="80767-121">并非所有服务提供商都支持事件通知;它是可选的，但强烈建议使用。</span><span class="sxs-lookup"><span data-stu-id="80767-121">Not all service providers support event notification; it is optional, but strongly recommended.</span></span> <span data-ttu-id="80767-122">邮件存储和通讯簿提供程序通常支持有关其多个对象的对象通知，并支持有关其内容和层次结构表的表通知。</span><span class="sxs-lookup"><span data-stu-id="80767-122">Message store and address book providers usually support object notifications on several of their objects and table notifications on their contents and hierarchy tables.</span></span> <span data-ttu-id="80767-123">传输提供程序不支持直接通知;它们依赖于与客户端通信的替代方法。</span><span class="sxs-lookup"><span data-stu-id="80767-123">Transport providers do not support notifications directly; they rely on alternative methods of communication with clients.</span></span>
  
<span data-ttu-id="80767-124">与通知接收器不同，建议源对象不是 MAPI 对象的唯一类型。</span><span class="sxs-lookup"><span data-stu-id="80767-124">Unlike advise sinks, advise source objects are not a unique type of MAPI object.</span></span> <span data-ttu-id="80767-125">许多 MAPI 对象（如邮件存储和表）都可以扮演建议源的角色。</span><span class="sxs-lookup"><span data-stu-id="80767-125">Many MAPI objects, such as message stores and tables, can take on the role of advise source.</span></span> <span data-ttu-id="80767-126">建议源是任何执行以下操作的 MAPI 对象：</span><span class="sxs-lookup"><span data-stu-id="80767-126">An advise source is any MAPI object that does the following:</span></span>
  
- <span data-ttu-id="80767-127">实现 **用于接收通知** 注册的 Advise 方法。</span><span class="sxs-lookup"><span data-stu-id="80767-127">Implements an **Advise** method to receive notification registrations.</span></span> 
    
- <span data-ttu-id="80767-128">实现 **Unadvise** 方法以接收通知取消。</span><span class="sxs-lookup"><span data-stu-id="80767-128">Implements an **Unadvise** method to receive notification cancellations.</span></span> 
    
- <span data-ttu-id="80767-129">向通过调用 **其 IMAPIAdviseSink：：OnNotify** 方法注册的适当建议接收对象生成相应类型的通知。</span><span class="sxs-lookup"><span data-stu-id="80767-129">Generates notifications of the appropriate type to the appropriate advise sink objects that have registered by calling their **IMAPIAdviseSink::OnNotify** methods.</span></span> 
    
<span data-ttu-id="80767-130">实现通知接收对象的客户端在想要注册通知时调用 **Advise（** 在大多数情况下，传递应进行注册的对象的条目标识符）和 **Unadvise（** 当他们希望取消注册时）。</span><span class="sxs-lookup"><span data-stu-id="80767-130">Clients that implement advise sink objects call **Advise** when they want to register for a notification, in most cases passing in the entry identifier of the object with which registration should occur, and **Unadvise** when they want to cancel the registration.</span></span> <span data-ttu-id="80767-131">客户端向 Advise **传递** 一个参数，指示要监视几种类型的事件。</span><span class="sxs-lookup"><span data-stu-id="80767-131">Clients pass a parameter to **Advise** that indicates which of the several types of events they want to monitor.</span></span> <span data-ttu-id="80767-132">**Advise** 返回一个非零数，代表通知接收器与建议源之间的连接成功。</span><span class="sxs-lookup"><span data-stu-id="80767-132">**Advise** returns a nonzero number that represents a successful connection between the advise sink and advise source.</span></span> 
  
<span data-ttu-id="80767-133">在调用 **Advise** 之前，客户端可以通过检查邮件存储的 PR_STORE_SUPPORT_MASK ([PidTagStoreSupportMask](pidtagstoresupportmask-canonical-property.md)) 属性中是否设置了 STORE_NOTIFY_OK 标志来确定邮件存储提供程序是否支持通知。</span><span class="sxs-lookup"><span data-stu-id="80767-133">Before calling **Advise**, clients can determine whether a message store provider supports notification by checking that the STORE_NOTIFY_OK flag is set in the message store's **PR_STORE_SUPPORT_MASK** ([PidTagStoreSupportMask](pidtagstoresupportmask-canonical-property.md)) property.</span></span> <span data-ttu-id="80767-134">客户端无法提前确定通讯簿提供程序是否支持通知。</span><span class="sxs-lookup"><span data-stu-id="80767-134">There is no way for clients to determine ahead of time whether or not an address book provider supports notifications.</span></span> <span data-ttu-id="80767-135">客户端必须尝试注册，如果尝试失败，它们可以假定通知不受支持。</span><span class="sxs-lookup"><span data-stu-id="80767-135">Clients must attempt to register and if the attempt fails, they can assume notifications are unsupported.</span></span>
  
<span data-ttu-id="80767-136">当客户端已注册的事件发生时，通知源会通过调用其 [IMAPIAdviseSink：：OnNotify](imapiadvisesink-onnotify.md) 方法（其中包含事件相关信息的通知数据结构）通知通知接收者。</span><span class="sxs-lookup"><span data-stu-id="80767-136">When an event for which a client has registered occurs, the advise source notifies the advise sink by calling its [IMAPIAdviseSink::OnNotify](imapiadvisesink-onnotify.md) method with a notification data structure that contains information about the event.</span></span> <span data-ttu-id="80767-137">通知接收器的 **OnNotify** 实现可以执行任务以响应通知，例如更新内存中的数据或刷新屏幕显示。</span><span class="sxs-lookup"><span data-stu-id="80767-137">An advise sink's implementation of **OnNotify** can perform tasks in response to the notification, such as updating data in memory or refreshing a screen display.</span></span> 
  
<span data-ttu-id="80767-138">服务提供商可以手动实现对通知的支持，或利用以下三种 **IMAPISupport** 方法中提供的帮助 [：IMAPISupport：：Subscribe、IMAPISupport：：Unsubscribe](imapisupport-subscribe.md)和 [IMAPISupport：：Notify](imapisupport-notify.md)。 [](imapisupport-unsubscribe.md)</span><span class="sxs-lookup"><span data-stu-id="80767-138">Service providers can implement support for notifications manually or take advantage of the help provided in three **IMAPISupport** methods: [IMAPISupport::Subscribe](imapisupport-subscribe.md), [IMAPISupport::Unsubscribe](imapisupport-unsubscribe.md), and [IMAPISupport::Notify](imapisupport-notify.md).</span></span> <span data-ttu-id="80767-139">Subscribe 和 **Unsubscribe** 方法处理提供程序的通知注册和取消注册;**Notify** 方法在适当时处理发送通知。</span><span class="sxs-lookup"><span data-stu-id="80767-139">The **Subscribe** and **Unsubscribe** methods handle notification registration and deregistration for providers; the **Notify** method handles sending notifications when appropriate.</span></span> 
  
<span data-ttu-id="80767-140">若要使用支持对象方法进行通知注册，服务提供商会调用 [IMAPISupport：：Subscribe](imapisupport-subscribe.md) 的 **Advise** 方法，并传递到 **Subscribe** 通知接收器指针，客户端会传递给 **Advise**。</span><span class="sxs-lookup"><span data-stu-id="80767-140">To use the support object methods for notification registration, service providers call [IMAPISupport::Subscribe](imapisupport-subscribe.md) in their **Advise** methods and pass to **Subscribe** the advise sink pointer that clients pass to **Advise**.</span></span> <span data-ttu-id="80767-141">如果将条目标识符作为输入参数传递以指定建议源，服务提供商会将其转换为二进制密钥。</span><span class="sxs-lookup"><span data-stu-id="80767-141">If an entry identifier is passed as an input parameter to specify an advise source, service providers convert it to a binary key.</span></span> <span data-ttu-id="80767-142">**Subscribe** 创建一个唯一的连接号码，服务提供商将返回此号码给客户端。</span><span class="sxs-lookup"><span data-stu-id="80767-142">**Subscribe** creates a unique connection number and it is this number that service providers return to clients.</span></span> <span data-ttu-id="80767-143">服务提供程序可以在 Advise 调用完成后随时释放客户端的建议接收对象指针。 </span><span class="sxs-lookup"><span data-stu-id="80767-143">Service providers can release the client's advise sink object pointer at any time after the **Advise** call has completed.</span></span> 
  
<span data-ttu-id="80767-144">当客户端调用 **Unadvise** 以取消注册时，服务提供商会根据客户端的建议接收指针或调用 **Unsubscribe** 来缩小引用计数，以执行相同的操作。</span><span class="sxs-lookup"><span data-stu-id="80767-144">When clients call **Unadvise** to cancel a registration, service providers either decrement the reference count on the client's advise sink pointer or call **Unsubscribe** to do the same.</span></span> 
  
<span data-ttu-id="80767-145">当生成通知时，服务提供商将执行与通知相关的任何内部处理，并初始化 [NOTIFICATION](notification.md) 结构，具体方法为将它所有未使用的成员都设置为零。</span><span class="sxs-lookup"><span data-stu-id="80767-145">When it is time to generate a notification, service providers perform any internal processing that relates to the notification and initializes a [NOTIFICATION](notification.md) structure by setting all of its unused members to zero.</span></span> <span data-ttu-id="80767-146">这种初始化 **NOTIFICATION** 结构的技术可帮助客户端创建更小、更快、更不容易出错的 **OnNotify** 实现。</span><span class="sxs-lookup"><span data-stu-id="80767-146">This technique for initializing the **NOTIFICATION** structure can help clients create smaller, faster, and less error-prone **OnNotify** implementations.</span></span> 
  
<span data-ttu-id="80767-147">下图显示了通知接收器对象、建议源对象和 MAPI 之间的通信。</span><span class="sxs-lookup"><span data-stu-id="80767-147">The following illustration shows the communication between advise sink objects, advise source objects, and MAPI.</span></span> <span data-ttu-id="80767-148">仅在建议源调用 **IMAPISupport** 方法进行通知支持时，才涉及 MAPI。</span><span class="sxs-lookup"><span data-stu-id="80767-148">MAPI is involved only when the advise source calls the **IMAPISupport** methods for notification support.</span></span> 
  
<span data-ttu-id="80767-149">**事件通知调用**</span><span class="sxs-lookup"><span data-stu-id="80767-149">**Event notification calls**</span></span>
  
<span data-ttu-id="80767-150">![事件通知调用](media/amapi_51.gif "事件通知调用")</span><span class="sxs-lookup"><span data-stu-id="80767-150">![Event notification calls](media/amapi_51.gif "Event notification calls")</span></span>
  
<span data-ttu-id="80767-151">MFCMAPI **CAdviseSink** 类 (AdviseSink.h 和 AdviseSink.cpp 文件) 对 Advise 的所有调用实现 advise 接收器 **对象**。</span><span class="sxs-lookup"><span data-stu-id="80767-151">The MFCMAPI **CAdviseSink** class (using the AdviseSink.h and AdviseSink.cpp files) implements the advise sink object for all calls to **Advise**.</span></span> <span data-ttu-id="80767-152">有关 MFCMAPI 的信息，请参阅[MFCMAPI 作为代码示例](mfcmapi-as-a-code-sample.md)和[MFCMAPI。](https://go.microsoft.com/fwlink/?LinkId=124154)</span><span class="sxs-lookup"><span data-stu-id="80767-152">For more information about MFCMAPI, see [MFCMAPI as a Code Sample](mfcmapi-as-a-code-sample.md) and [MFCMAPI](https://go.microsoft.com/fwlink/?LinkId=124154).</span></span>
  

