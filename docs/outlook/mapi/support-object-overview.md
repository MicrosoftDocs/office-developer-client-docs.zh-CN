---
title: 支持对象概述
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 5b062891-39ab-4334-9706-5b376719d5e4
description: 上次修改时间：2011 年 7 月 23 日
ms.openlocfilehash: 55d8a9c78ae5132eaa8cf0f0aec5b252ef83b926
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/28/2019
ms.locfileid: "33433610"
---
# <a name="support-object-overview"></a><span data-ttu-id="5d8dd-103">支持对象概述</span><span class="sxs-lookup"><span data-stu-id="5d8dd-103">Support Object Overview</span></span>

  
  
<span data-ttu-id="5d8dd-104">**适用于**：Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="5d8dd-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="5d8dd-105">MAPI 为登录期间的所有服务提供商以及配置期间的所有邮件服务提供支持对象（一个实现 [IMAPISupport ： IUnknown](imapisupportiunknown.md) 接口的对象）。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-105">MAPI furnishes a support object, an object that implements the [IMAPISupport : IUnknown](imapisupportiunknown.md) interface, for all service providers during logon and for all message services during configuration.</span></span> 
  
<span data-ttu-id="5d8dd-106">客户端无法访问支持对象;它们由 MAPI 实现，并且仅由服务提供商调用。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-106">Support objects are not accessible by clients; they are implemented by MAPI and called only by service providers.</span></span> <span data-ttu-id="5d8dd-107">**IMAPISupport** 接口在 Mapispi.h 头文件中指定。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-107">The **IMAPISupport** interface is specified in the Mapispi.h header file.</span></span> <span data-ttu-id="5d8dd-108">它的标识符IID_IMAPISup指针类型是 LPMAPISUP。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-108">Its identifier is IID_IMAPISup and its pointer type is LPMAPISUP.</span></span> <span data-ttu-id="5d8dd-109">支持对象不会公开任何 MAPI 属性。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-109">No MAPI properties are exposed by support objects.</span></span> 
  
<span data-ttu-id="5d8dd-110">提供程序可以有一个或多个支持对象，具体取决于 MAPI 记录提供程序的时间或调用提供程序的邮件服务条目函数次数。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-110">A provider can be given one or more support objects, depending on the number of times MAPI logs the provider on or the number of times the provider's message service entry function is called.</span></span> <span data-ttu-id="5d8dd-111">通常，提供程序将至少每个会话登录一次。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-111">Typically, a provider will be logged on at least once per session.</span></span> <span data-ttu-id="5d8dd-112">每当客户端使用请求其的配置文件条目启动会话时，通讯簿和传输提供程序都会登录。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-112">Address book and transport providers are logged on every time a client starts a session with a profile entry that requests them.</span></span> <span data-ttu-id="5d8dd-113">每次客户端调用 [IMAPISession：：OpenMsgStore](imapisession-openmsgstore.md) 方法时，都会登录消息存储提供程序。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-113">Message store providers are logged on every time a client calls the [IMAPISession::OpenMsgStore](imapisession-openmsgstore.md) method.</span></span> 
  
<span data-ttu-id="5d8dd-114">在会话中多次登场的情况下，可以选择单独保留和使用每个支持对象，也可以选择仅保留并使用第一个，丢弃每个后续支持对象。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-114">In the case of multiple logons in a session, you can choose either to retain and use each support object separately or to retain and use only the first, discarding each subsequent support object.</span></span> <span data-ttu-id="5d8dd-115">若要保留支持对象，请调用其 **IUnknown：：AddRef** 方法。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-115">To retain a support object, call its **IUnknown::AddRef** method.</span></span> <span data-ttu-id="5d8dd-116">对要在整个会话中保留的支持对象调用 **AddRef** 非常重要;如果未进行调用，MAPI 将释放支持对象并释放其内存。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-116">Calling **AddRef** on a support object that you want to retain throughout a session is extremely important; if the call is not made, MAPI releases the support object and frees its memory.</span></span> 
  
<span data-ttu-id="5d8dd-117">支持对象的目的是为提供程序常用的大量方法提供实现。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-117">The purpose of the support object is to provide implementations for a fairly large number of methods commonly used by the providers.</span></span> <span data-ttu-id="5d8dd-118">每个支持对象还包含特定于其自己的实例的上下文数据，例如提供程序运行的会话、提供程序使用的配置文件部分以及会话的错误信息。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-118">Each support object also contains contextual data specific to its own instance, such as the session the provider is running in, the profile section the provider is using, and error information for the session.</span></span> 
  
<span data-ttu-id="5d8dd-119">支持对象有四种不同类型的：一种用于每个主要提供程序类型 (通讯簿、邮件存储和传输) 一种用于配置支持。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-119">There are four different types of support objects: one for each major provider type (address book, message store, and transport) and one for configuration support.</span></span> 
  
<span data-ttu-id="5d8dd-120">MAPI 通过包括与它的用法相关的方法实现来自定义每个支持对象。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-120">MAPI customizes each support object by including implementations of methods that are relevant for its usage.</span></span> <span data-ttu-id="5d8dd-121">某些方法（如 [IMAPISupport：：OpenProfileSection）](imapisupport-openprofilesection.md)的实现包含在所有支持对象中。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-121">Implementations of some methods, such as [IMAPISupport::OpenProfileSection](imapisupport-openprofilesection.md), are included in all support objects.</span></span> <span data-ttu-id="5d8dd-122">其他方法（如 [IMAPISupport：：SpoolerNotify）](imapisupport-spoolernotify.md)的实现仅适用于特定支持对象。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-122">Implementations of other methods, such as [IMAPISupport::SpoolerNotify](imapisupport-spoolernotify.md), apply only to particular support objects.</span></span> <span data-ttu-id="5d8dd-123">只有邮件存储和传输提供程序才能使用此方法;当通讯簿提供程序或邮件服务尝试调用它时，MAPI 将返回 MAPI_E_NO_SUPPORT。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-123">Only message store and transport providers can use this method; when an address book provider or a message service try to call it, MAPI returns MAPI_E_NO_SUPPORT.</span></span>
  
<span data-ttu-id="5d8dd-124">支持对象可用于完成许多任务，例如：</span><span class="sxs-lookup"><span data-stu-id="5d8dd-124">Support objects can be used to accomplish many tasks, such as the following:</span></span>
  
- <span data-ttu-id="5d8dd-125">访问配置文件部分。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-125">Accessing a profile section.</span></span>
    
- <span data-ttu-id="5d8dd-126">复制文件夹或邮件。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-126">Copying folders or messages.</span></span> <span data-ttu-id="5d8dd-127">有关详细信息，请参阅复制 [或移动邮件或文件夹](copying-or-moving-a-message-or-a-folder.md)。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-127">For more information, see [Copying or Moving a Message or a Folder](copying-or-moving-a-message-or-a-folder.md).</span></span>
    
- <span data-ttu-id="5d8dd-128">访问属于其他提供程序的对象。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-128">Accessing objects that belong to other providers.</span></span> <span data-ttu-id="5d8dd-129">有关详细信息，请参阅支持 [对象访问和比较](supporting-object-access-and-comparison.md)。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-129">For more information, see [Supporting Object Access and Comparison](supporting-object-access-and-comparison.md).</span></span> 
    
- <span data-ttu-id="5d8dd-130">处理事件通知。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-130">Handling event notification.</span></span> <span data-ttu-id="5d8dd-131">有关详细信息，请参阅支持 [事件通知](supporting-event-notification.md)。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-131">For more information, see [Supporting Event Notification](supporting-event-notification.md).</span></span>
    
- <span data-ttu-id="5d8dd-132">分配和释放内存。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-132">Allocating and freeing memory.</span></span>
    
- <span data-ttu-id="5d8dd-133">获取唯一标识符。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-133">Obtaining a unique identifier.</span></span>
    
- <span data-ttu-id="5d8dd-134">使对象无效。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-134">Invalidating objects.</span></span>
    
- <span data-ttu-id="5d8dd-135">处理错误。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-135">Handling errors.</span></span>
    
- <span data-ttu-id="5d8dd-136">注册邮件预处理器。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-136">Registering message preprocessors.</span></span> 
    
- <span data-ttu-id="5d8dd-137">准备邮件送达报告。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-137">Preparing message delivery reports.</span></span> 
    
<span data-ttu-id="5d8dd-138">在登录时，MAPI 调用每个服务提供商的提供程序对象的登录方法。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-138">At logon time, MAPI calls the logon method of each service provider's provider object.</span></span> <span data-ttu-id="5d8dd-139">对于通讯簿提供程序，MAPI 调用 [IABProvider：：Logon](iabprovider-logon.md)。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-139">For address book providers, MAPI calls [IABProvider::Logon](iabprovider-logon.md).</span></span> <span data-ttu-id="5d8dd-140">对于邮件存储提供程序，MAPI 调用 [IMSProvider：：Logon](imsprovider-logon.md)。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-140">For message store providers, MAPI calls [IMSProvider::Logon](imsprovider-logon.md).</span></span> <span data-ttu-id="5d8dd-141">对于传输提供程序，MAPI 调用 [IXPProvider：：TransportLogon](ixpprovider-transportlogon.md)。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-141">For transport providers, MAPI calls [IXPProvider::TransportLogon](ixpprovider-transportlogon.md).</span></span> <span data-ttu-id="5d8dd-142">MAPI 将指向此方法的参数之一中的相应支持对象的指针传递。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-142">MAPI passes a pointer to the appropriate support object in one of the parameters to this method.</span></span> <span data-ttu-id="5d8dd-143">登录方法反过来实例化登录对象，并传递支持对象指针。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-143">The logon method in turn instantiates a logon object, passing it the support object pointer.</span></span> <span data-ttu-id="5d8dd-144">登录对象调用支持对象的 **IUnknown：：AddRef** 方法来保留它（如有必要）。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-144">The logon object calls the support object's **IUnknown::AddRef** method to retain it, if necessary.</span></span> <span data-ttu-id="5d8dd-145">有关服务提供商的登录过程详细信息，请参阅启动 [服务提供程序](starting-a-service-provider.md)。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-145">For more information about the logon process for service providers, see [Starting a Service Provider](starting-a-service-provider.md).</span></span>
  
<span data-ttu-id="5d8dd-146">客户端注销后，MAPI 将调用登录对象的 logoff 方法。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-146">When a client logs off, MAPI calls the logon object's logoff method.</span></span> <span data-ttu-id="5d8dd-147">logoff 方法调用支持对象的 **IUnknown：：Release** 方法，以指示提供程序不再打算调用任何支持方法。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-147">The logoff method calls the support object's **IUnknown::Release** method to indicate that the provider no longer intends to call any of the support methods.</span></span> <span data-ttu-id="5d8dd-148">与登录一样，注销方法的名称略有不同。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-148">As with logon, the logoff methods have slightly different names.</span></span> <span data-ttu-id="5d8dd-149">[IABLogon 和](iablogoniunknown.md) [IMSLogon](imslogoniunknown.md)接口具有 **Logoff** 方法;[IXPLogon](ixplogoniunknown.md)接口具有 [TransportLogoff](ixplogon-transportlogoff.md)方法。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-149">The [IABLogon](iablogoniunknown.md) and [IMSLogon](imslogoniunknown.md) interfaces have **Logoff** methods; the [IXPLogon](ixplogoniunknown.md) interface has a [TransportLogoff](ixplogon-transportlogoff.md) method.</span></span> 
  
<span data-ttu-id="5d8dd-150">当登录尝试失败，出现错误或客户端启动配置MAPI_E_UNCONFIGURED调用消息服务入口点函数。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-150">Message service entry point functions are called when a logon attempt fails with the error MAPI_E_UNCONFIGURED or when a client initiates a configuration request.</span></span> <span data-ttu-id="5d8dd-151">MAPI 实例化配置支持对象，并调用未配置提供程序或其配置即将更改的提供程序的消息服务入口点函数。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-151">MAPI instantiates a configuration support object and calls the message service entry point function for either the unconfigured provider or the provider whose configuration is about to change.</span></span> <span data-ttu-id="5d8dd-152">与其他支持对象不同，配置支持对象仅在入口点函数返回之前有效;邮件服务不调用这些对象的 **AddRef** 方法来保留它们。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-152">Unlike the other support objects, configuration support objects are valid only until the entry point function returns; message services do not call these objects' **AddRef** methods to retain them.</span></span> 
  
<span data-ttu-id="5d8dd-153">通常，MAPI 调用提供程序的邮件服务入口点功能，但有时会要求提供程序进行调用。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-153">Typically, MAPI makes calls to a provider's message service entry point function, but sometimes a provider is asked to make the call.</span></span> <span data-ttu-id="5d8dd-154">当客户端调用提供程序的 [IMAPIStatus：：SettingsDialog](imapistatus-settingsdialog.md) 方法以提示提供程序显示其配置时，属性表。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-154">This can occur when a client calls a provider's [IMAPIStatus::SettingsDialog](imapistatus-settingsdialog.md) method to prompt the provider to display its configuration property sheet.</span></span> <span data-ttu-id="5d8dd-155">**SettingsDialog** 应调用 [IMAPISupport：：GetSvcConfigSupportObj](imapisupport-getsvcconfigsupportobj.md) 以获取可以传递给邮件服务入口点函数的配置支持对象。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-155">**SettingsDialog** should call [IMAPISupport::GetSvcConfigSupportObj](imapisupport-getsvcconfigsupportobj.md) to obtain a configuration support object that it can pass to the message service entry point function.</span></span> 
  
<span data-ttu-id="5d8dd-156">[IMAPISupport：：GetMemAllocRoutines](imapisupport-getmemallocroutines.md)方法可用于确定内存分配和释放函数的地址，而无需与 MAPI 链接。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-156">The [IMAPISupport::GetMemAllocRoutines](imapisupport-getmemallocroutines.md) method is available for determining the addresses of the memory allocation and deallocation functions without having to link with MAPI.</span></span> <span data-ttu-id="5d8dd-157">通过使用 **GetMemAllocRoutines，** 通过使用调试代码围绕分配函数调用来更轻松地跟踪内存泄漏。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-157">Using **GetMemAllocRoutines** also makes it easier to trace memory leaks by surrounding the allocation function calls with debugging code.</span></span> <span data-ttu-id="5d8dd-158">如果按照建议调用 **GetMemAllocRoutines**，则先调用 [CreateIProp](createiprop.md) 函数，这需要分配函数地址作为参数。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-158">If you call **GetMemAllocRoutines**, as is recommended, do so before calling the [CreateIProp](createiprop.md) function, which requires the allocation function addresses as parameters.</span></span> 
  
<span data-ttu-id="5d8dd-159">当需要创建新的通讯簿或邮件存储对象时，请在其 **PR_SEARCH_KEY** ([PidTagSearchKey](pidtagsearchkey-canonical-property.md)) 属性中为该对象创建和设置搜索密钥。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-159">When you need to create a new address book or message store object, create and set a search key for the object in its **PR_SEARCH_KEY** ([PidTagSearchKey](pidtagsearchkey-canonical-property.md)) property.</span></span> <span data-ttu-id="5d8dd-160">调用 [IMAPISupport：：NewUID](imapisupport-newuid.md) 以获取用于生成搜索密钥的唯一标识符。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-160">Call [IMAPISupport::NewUID](imapisupport-newuid.md) to obtain a unique identifier to use in building a search key.</span></span> <span data-ttu-id="5d8dd-161">请勿使用自己的硬编码 [MAPIUID](mapiuid.md)。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-161">Do not use your own hard-coded [MAPIUID](mapiuid.md).</span></span> <span data-ttu-id="5d8dd-162">提供程序的 **MAPIUID** 应仅用于条目标识符。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-162">A provider's **MAPIUID** should be used only for entry identifiers.</span></span> <span data-ttu-id="5d8dd-163">有关构造搜索键的信息，请参阅[MAPI Record and Search Keys。](mapi-record-and-search-keys.md)</span><span class="sxs-lookup"><span data-stu-id="5d8dd-163">For more information about constructing search keys, see [MAPI Record and Search Keys](mapi-record-and-search-keys.md).</span></span>
  
<span data-ttu-id="5d8dd-164">客户端应用程序有时可以释放对象，而不会释放其一个或多个附属对象。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-164">A client application can sometimes release an object without releasing one or more of its affiliated objects.</span></span> <span data-ttu-id="5d8dd-165">在这种情况下，提供程序可能需要呈现一个不可用的未响应对象。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-165">In such a case, a provider may need to render an unreleased object unusable.</span></span> <span data-ttu-id="5d8dd-166">为此，提供程序将释放与对象连接的所有资源，然后调用 [IMAPISupport：：MakeInvalid](imapisupport-makeinvalid.md) 使对象的 vtable 无效。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-166">To do this, the provider frees all of the resources connected with the object and then calls [IMAPISupport::MakeInvalid](imapisupport-makeinvalid.md) to invalidate the object's vtable.</span></span> <span data-ttu-id="5d8dd-167">**MakeInvalid** 将 vtable 的 **IUnknown** 方法 (**QueryInterface、AddRef** 和 **Release**) 替换为标准 MAPI 实现，并会导致所有其他方法返回 MAPI_E_INVALID_OBJECT。 </span><span class="sxs-lookup"><span data-stu-id="5d8dd-167">**MakeInvalid** replaces the vtable's **IUnknown** methods (**QueryInterface**, **AddRef**, and **Release**) with standard MAPI implementations and causes all other methods to return MAPI_E_INVALID_OBJECT.</span></span> <span data-ttu-id="5d8dd-168">**MakeInvalid** 还释放除 vtable 对象外的所有对象内存。</span><span class="sxs-lookup"><span data-stu-id="5d8dd-168">**MakeInvalid** also frees all the object's memory other than the vtable.</span></span> 
  
## <a name="see-also"></a><span data-ttu-id="5d8dd-169">另请参阅</span><span class="sxs-lookup"><span data-stu-id="5d8dd-169">See also</span></span>



[<span data-ttu-id="5d8dd-170">MAPI 服务提供程序</span><span class="sxs-lookup"><span data-stu-id="5d8dd-170">MAPI Service Providers</span></span>](mapi-service-providers.md)

