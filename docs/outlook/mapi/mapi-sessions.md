---
title: MAPI 会话
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: c5a7c137-393e-40ff-a2b9-afe02da2435a
description: 上次修改时间：2011 年 7 月 23 日
ms.openlocfilehash: 3dd55d8ee3cb2751fb27184f0069ae831e2164ee
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/23/2019
ms.locfileid: "32319579"
---
# <a name="mapi-sessions"></a><span data-ttu-id="7e7c8-103">MAPI 会话</span><span class="sxs-lookup"><span data-stu-id="7e7c8-103">MAPI sessions</span></span>

<span data-ttu-id="7e7c8-104">**适用于**：Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="7e7c8-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="7e7c8-105">在客户端应用程序可以调用基础邮件系统之前, 它必须使用 MAPI 子系统建立会话或连接。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-105">Before the client application can call an underlying messaging system, it must establish a session, or connection, with the MAPI subsystem.</span></span>
  
<span data-ttu-id="7e7c8-106">会话在用户登录时启动, 该过程可访问有效的配置文件, 并验证邮件系统和邮件服务凭据。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-106">Sessions are initiated when a user logs on, a process that accesses a valid profile and validates the messaging system and the message service credentials.</span></span> <span data-ttu-id="7e7c8-107">然后, 此过程可确保正确配置所有配置文件的邮件服务。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-107">Then, the process ensures that all of the profile's message services are correctly configured.</span></span> <span data-ttu-id="7e7c8-108">您使用的客户端接口决定了登录呼叫。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-108">The client interface you use determines the logon call.</span></span> <span data-ttu-id="7e7c8-109">MAPI 客户端调用[MAPILogonEx](mapilogonex.md)函数。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-109">MAPI clients call the [MAPILogonEx](mapilogonex.md) function.</span></span> 
  
<span data-ttu-id="7e7c8-110">邮件服务配置是登录过程中最重要的部分之一。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-110">Message service configuration is one of the most important parts of the logon process.</span></span> <span data-ttu-id="7e7c8-111">配置文件是配置信息的初始源。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-111">The profile is the initial source for configuration information.</span></span> <span data-ttu-id="7e7c8-112">如果缺少特定邮件服务的信息, 登录过程将尝试提示用户提供此信息。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-112">If information for a particular message service is missing, the logon process tries to prompt the user to supply it.</span></span> <span data-ttu-id="7e7c8-113">这并不总是成功, 原因有两个: 首先, 提示用户需要显示对话框。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-113">This is not always successful for two reasons: First, prompting the user requires the display of a dialog box.</span></span> <span data-ttu-id="7e7c8-114">客户端可以通过将标志传递到登录呼叫来禁止显示用户界面。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-114">It is possible for clients to disallow the display of a user interface by passing a flag into the logon call.</span></span> <span data-ttu-id="7e7c8-115">其次, 用户可以先取消对话框, 然后再添加所需的信息。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-115">Second, the user could cancel the dialog box before the needed information can be added.</span></span>
  
<span data-ttu-id="7e7c8-116">当登录过程失败一次时, 用户会收到故障通知, 并将有机会重试或更正错误条件。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-116">When a logon process fails one time, the user is informed of the failure and given the chance to retry or correct the error condition.</span></span> <span data-ttu-id="7e7c8-117">同样, 如果客户端允许, 将显示用户界面, 并且系统会提示用户输入丢失的任何数据。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-117">Once again, a user interface will be displayed, if the client allows it, and the user will be prompted to enter whatever data is missing.</span></span> <span data-ttu-id="7e7c8-118">如果第二次尝试失败, MAPI 将在会话期间禁用邮件服务中的所有服务提供程序。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-118">If this second try is unsuccessful, MAPI disables all service providers in the message service for the duration of the session.</span></span> <span data-ttu-id="7e7c8-119">实际上, 整个邮件服务已被禁用。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-119">In effect, the whole message service is disabled.</span></span> <span data-ttu-id="7e7c8-120">这意味着邮件服务中的任何服务提供程序都不能正常工作。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-120">This means that none of the service providers in the message service can work.</span></span> <span data-ttu-id="7e7c8-121">这样做是因为如果一个提供程序失败登录, 则其他提供程序通常也会失败。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-121">This is done because if one provider fails logon, the other providers usually also fail.</span></span> <span data-ttu-id="7e7c8-122">登录过程可能会失败, 因为所需资源的路径无效、MAPI 的不兼容版本、不可用的邮件服务器或数据损坏。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-122">The logon process can fail due to an invalid path for a necessary resource, an incompatible version of MAPI, an unavailable messaging server, or data corruption.</span></span> 
  
<span data-ttu-id="7e7c8-123">客户端可以指定在登录呼叫中建立的两种会话类型之一: 单个会话或共享会话。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-123">Clients can specify one of two types of sessions to be established in the logon call: an individual session or a shared session.</span></span> <span data-ttu-id="7e7c8-124">单个会话是专用连接;客户端应用程序和它使用的会话之间存在一对一的关系。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-124">Individual sessions are private connections; there is a one-to-one relationship between a client application and the session it is using.</span></span> <span data-ttu-id="7e7c8-125">因此, 共享会话的客户端应用程序也共享配置文件。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-125">As a consequence, client applications that share a session also share a profile.</span></span> <span data-ttu-id="7e7c8-126">共享会话已建立一次, 但可供需要使用它们的其他客户端应用程序使用。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-126">Shared sessions are established once but can be used by other client applications that need to use them.</span></span> <span data-ttu-id="7e7c8-127">配置文件和凭据仅在初始登录时指定。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-127">The profile and credentials are specified only with the initial logon.</span></span> 
  
<span data-ttu-id="7e7c8-128">客户端可以作为同一个用户或多个用户登录多次。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-128">Clients can log on multiple times as the same user or as multiple users.</span></span> <span data-ttu-id="7e7c8-129">MAPI 不会阻止这种情况发生。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-129">MAPI does not prevent this.</span></span> <span data-ttu-id="7e7c8-130">但是, 某些服务提供程序可能不会很灵活, 在后续登录尝试中返回错误值 MAPI_E_SESSION_LIMIT。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-130">Some service providers, however, might not be as flexible, returning the error value MAPI_E_SESSION_LIMIT on subsequent logon attempts.</span></span> <span data-ttu-id="7e7c8-131">可能需要具有基础硬件限制的服务提供程序才能强制实施会话限制。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-131">Service providers with underlying hardware limitations can be required to enforce a session limit.</span></span>
  
<span data-ttu-id="7e7c8-132">用于建立会话的函数调用具有一个标志和参数的集合, 用于控制会话的创建方式。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-132">The function calls for establishing a session have a collection of flags and parameters that control how the session is created.</span></span> <span data-ttu-id="7e7c8-133">客户端指定一个可选的配置文件名称和一个窗口句柄, 用作显示的任何对话框的父窗口。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-133">The client specifies an optional profile name and a window handle that acts as the parent window for any dialog boxes that are displayed.</span></span> <span data-ttu-id="7e7c8-134">这些标志包括 MAPI_NEW_SESSION, 后者请求建立新的单个会话 (而不是共享会话) 和 MAPI_LOGON_UI 用户界面标志。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-134">The flags include MAPI_NEW_SESSION, which requests that a new, individual session (rather than a shared session) be established, and the MAPI_LOGON_UI user interface flag.</span></span> <span data-ttu-id="7e7c8-135">将用户界面标志设置为 "请求登录" 对话框。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-135">The user interface flag is set to request a logon dialog box.</span></span>
  
<span data-ttu-id="7e7c8-136">下图显示了这些不同的参数和标志如何建立 MAPI 会话。</span><span class="sxs-lookup"><span data-stu-id="7e7c8-136">The following illustration shows how these various parameters and flags establish a MAPI session.</span></span>
  
<span data-ttu-id="7e7c8-137">**MAPI 会话流程图**</span><span class="sxs-lookup"><span data-stu-id="7e7c8-137">**MAPI session flowchart**</span></span>
  
<span data-ttu-id="7e7c8-138">![MAPI 会话流程图](media/amapi_47.gif "MAPI 会话流程图")</span><span class="sxs-lookup"><span data-stu-id="7e7c8-138">![MAPI session flowchart](media/amapi_47.gif "MAPI session flowchart")</span></span>
  
<span data-ttu-id="7e7c8-139">有关在客户端应用程序中处理会话的信息, 请参阅[MAPI 会话处理](mapi-session-handling.md)</span><span class="sxs-lookup"><span data-stu-id="7e7c8-139">For information about handling sessions from within a client application, see [MAPI Session Handling](mapi-session-handling.md)</span></span>
  
## <a name="see-also"></a><span data-ttu-id="7e7c8-140">另请参阅</span><span class="sxs-lookup"><span data-stu-id="7e7c8-140">See also</span></span>

- [<span data-ttu-id="7e7c8-141">MAPILogonEx</span><span class="sxs-lookup"><span data-stu-id="7e7c8-141">MAPILogonEx</span></span>](mapilogonex.md)  
- [<span data-ttu-id="7e7c8-142">IMAPISession : IUnknown</span><span class="sxs-lookup"><span data-stu-id="7e7c8-142">IMAPISession : IUnknown</span></span>](imapisessioniunknown.md)
- [<span data-ttu-id="7e7c8-143">MAPI 会话处理</span><span class="sxs-lookup"><span data-stu-id="7e7c8-143">MAPI Session Handling</span></span>](mapi-session-handling.md)  
- [<span data-ttu-id="7e7c8-144">MAPI 编程概述</span><span class="sxs-lookup"><span data-stu-id="7e7c8-144">MAPI Programming Overview</span></span>](mapi-programming-overview.md)

